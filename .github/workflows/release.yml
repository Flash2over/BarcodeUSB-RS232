name: Release Firmware

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install ARM Cross Compiler + Build Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build gcc-arm-none-eabi libnewlib-arm-none-eabi build-essential

    - name: Fetch pico-sdk (RP2350)
      run: |
        git clone https://github.com/raspberrypi/pico-sdk.git
        cd pico-sdk
        git submodule update --init
      env:
        PICO_SDK_PATH: ${{ github.workspace }}/pico-sdk

    - name: Configure CMake
      env:
        PICO_SDK_PATH: ${{ github.workspace }}/pico-sdk
      run: |
        mkdir -p build
        cd build
        cmake .. \
          -G Ninja \
          -DPICO_BOARD=pico2 \
          -DPICO_SDK_PATH=${PICO_SDK_PATH} \
          -DCMAKE_C_COMPILER=arm-none-eabi-gcc \
          -DCMAKE_CXX_COMPILER=arm-none-eabi-g++

    - name: Build Firmware
      run: |
        cd build
        ninja

    - name: Rename firmware for release
      run: |
        VERSION="${GITHUB_REF_NAME}"
        cp build/pico2-barcode-rs232.uf2 "barcodeusb-rs232-${VERSION}.uf2"

    - name: Create Release and Upload Artifact
      uses: softprops/action-gh-release@v2
      with:
        files: |
          barcodeusb-rs232-*.uf2
